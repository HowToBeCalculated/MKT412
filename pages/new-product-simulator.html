<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MKT412 — New Product Launch Simulator</title>
  <style>
    :root {
      /* Bryant University palette per project brief */
      --bg: #1a1a1a;         /* near-black */
      --fg: #e0e0e0;         /* light gray text */
      --accent: #e6a700;     /* Bryant gold */
      --card: #222222;       /* dark card */
      --muted: #bdbdbd;      /* muted text */
      --grid: #333333;       /* chart grid */
      --good: #50c878;       /* emerald for positive */
      --bad: #ff6b6b;        /* soft red for negative */
    }

    * { box-sizing: border-box; }

    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--fg);
      background: radial-gradient(1200px 800px at 10% -10%, #202020, var(--bg));
    }

    header {
      position: sticky; top: 0; z-index: 3;
      backdrop-filter: blur(8px);
      background: color-mix(in oklab, var(--bg), transparent 35%);
      border-bottom: 1px solid #2a2a2a;
    }

    .wrap { max-width: 1260px; margin: 0 auto; padding: 16px 20px; }

    .title {
      display: flex; align-items: center; gap: 14px;
    }
    .logo {
      width: 36px; height: 36px; border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), #f0ca45);
      box-shadow: 0 0 0 2px #000 inset, 0 6px 18px rgba(0,0,0,.35);
    }
    h1 { font-size: 20px; margin: 0; letter-spacing: .2px; }
    .subtitle { font-size: 12px; color: var(--muted); }

    .container {
      max-width: 1260px; margin: 18px auto; display: grid; gap: 16px;
      grid-template-columns: 360px 1fr; align-items: start; padding: 0 20px 28px;
    }

    .card { background: var(--card); border: 1px solid #2a2a2a; border-radius: 14px; }
    .card h2 { font-size: 15px; margin: 0 0 8px 0; color: var(--accent); }
    .card .pad { padding: 14px; }

    /* Controls */
    .controls { position: sticky; top: 68px; }
    .control { display: grid; grid-template-columns: 1fr 96px; gap: 10px; align-items: center; padding: 10px 0; border-bottom: 1px dashed #2c2c2c; }
    .control:last-child { border-bottom: none; }
    .control label { font-size: 12px; color: var(--fg); display: block; }
    .control small { color: var(--muted); font-size: 11px; }
    .control input[type="range"] { grid-column: 1 / span 2; width: 100%; accent-color: var(--accent); }
    .number { width: 100%; padding: 6px 8px; border-radius: 8px; border: 1px solid #3a3a3a; background: #111; color: var(--fg); font-variant-numeric: tabular-nums; }

    .row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }

    .btnbar { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
    button {
      appearance: none; border: 1px solid #3a2a00; color: #181400; background: var(--accent);
      padding: 8px 12px; border-radius: 10px; font-weight: 650; cursor: pointer; box-shadow: 0 4px 14px rgba(0,0,0,.25);
    }
    button.secondary { background: #121212; color: var(--fg); border: 1px solid #323232; }

    .info{display:inline-flex;align-items:center;justify-content:center;width:16px;height:16px;border-radius:50%;border:1px solid #554400;color:var(--accent);font-size:11px;margin-left:6px;cursor:help;position:relative;}
    .info::after{content:attr(data-tip);position:absolute;left:50%;bottom:100%;transform:translate(-50%,-8px);background:#111;border:1px solid #444;color:var(--fg);padding:6px 8px;border-radius:8px;box-shadow:0 8px 18px rgba(0,0,0,.45);white-space:normal;max-width:260px;opacity:0;visibility:hidden;transition:opacity .12s ease, visibility .12s ease;pointer-events:none;z-index:10;}
    .info::before{content:'';position:absolute;left:50%;bottom:calc(100% - 4px);transform:translateX(-50%) rotate(45deg);width:8px;height:8px;background:#111;border-left:1px solid #444;border-top:1px solid #444;opacity:0;visibility:hidden;transition:opacity .12s ease, visibility .12s ease;pointer-events:none;z-index:10;}
    .info:hover::after,.info:focus-visible::after,.info.show::after,.info:hover::before,.info:focus-visible::before,.info.show::before{opacity:1;visibility:visible;}

    /* KPIs */
    .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    .kpi { padding: 12px; border-radius: 12px; border: 1px solid #2b2b2b; background: #191919; }
    .kpi .label { font-size: 12px; color: var(--muted); }
    .kpi .value { font-size: 20px; font-variant-numeric: tabular-nums; margin-top: 4px; }
    .kpi .delta { font-size: 11px; margin-top: 2px; color: var(--muted); }

    .charts { display: grid; grid-template-columns: 1fr; gap: 12px; }
    .chart { padding: 10px; }
    canvas { width: 100%; height: 260px; display: block; background: #111; border: 1px solid #2a2a2a; border-radius: 12px; }

    .table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .table th, .table td { border-bottom: 1px solid #2a2a2a; padding: 8px; }
    .table th { text-align: left; color: var(--muted); font-weight: 600; }

    .insights { font-size: 13px; line-height: 1.45; color: var(--fg); }
    .insights b { color: var(--accent); }

    .footer-note { color: var(--muted); font-size: 11px; margin-top: 8px; }

    @media (max-width: 980px) {
      .container { grid-template-columns: 1fr; }
      .controls { position: static; }
      .kpis { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap title">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>MKT412 · New Product Launch Simulator</h1>
        <div class="subtitle">Adjust the levers ➜ simulate uncertainty ➜ study probabilistic outcomes (Monte Carlo)</div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- LEFT: Controls -->
    <aside class="card controls">
      <div class="pad">
        <h2>Levers</h2>
        <div class="control">
          <div>
            <label for="tam">Total Addressable Market (TAM)<span class="info" title="Total Addressable Market: The total potential customers or revenue for a product/service in the entire market.">ⓘ</span></label>
            <small>Total potential customers in the broader market</small>
          </div>
          <input class="number" id="tam_n" type="number" min="10000" step="1000" />
          <input id="tam" type="range" min="10000" max="2000000" step="1000" />
        </div>

        <div class="control">
          <div>
            <label for="sam_pct">Addressable Share (SAM % of TAM)<span class="info" title="Serviceable Addressable Market: The portion of the Total Addressable Market that your business can realistically reach and serve.">ⓘ</span></label>
            <small>The portion of the market you can realistically serve</small>
          </div>
          <input class="number" id="sam_pct_n" type="number" min="1" max="100" step="1" />
          <input id="sam_pct" type="range" min="1" max="100" step="1" />
        </div>

        <div class="control">
          <div>
            <label for="months">Horizon (months)<span class="info" title="The total time duration, in months, for which the simulation will run.">ⓘ</span></label>
            <small>Length of the simulation period</small>
          </div>
          <input class="number" id="months_n" type="number" min="6" max="60" step="1" />
          <input id="months" type="range" min="6" max="60" step="1" />
        </div>

        <div class="row">
          <div class="control">
            <div>
              <label for="price">Price ($)<span class="info" title="The average selling price per unit of your product.">ⓘ</span></label>
              <small>Average selling price per unit</small>
            </div>
            <input class="number" id="price_n" type="number" min="1" step="1" />
            <input id="price" type="range" min="1" max="999" step="1" />
          </div>
          <div class="control">
            <div>
              <label for="unit_cost">Unit Cost ($)<span class="info" title="The variable cost associated with producing or acquiring one unit of the product (Cost of Goods Sold or COGS).">ⓘ</span></label>
              <small>Cost of Goods Sold (COGS) per unit</small>
            </div>
            <input class="number" id="unit_cost_n" type="number" min="0" step="1" />
            <input id="unit_cost" type="range" min="0" max="999" step="1" />
          </div>
        </div>

        <div class="row">
          <div class="control">
            <div>
              <label for="fixed_cost">Fixed Cost / mo ($)<span class="info" title="Costs that remain constant regardless of production or sales volume, such as rent, salaries, or software subscriptions, measured per month.">ⓘ</span></label>
              <small>Monthly overhead costs (e.g., salaries, rent, software subscriptions)</small>
            </div>
            <input class="number" id="fixed_cost_n" type="number" min="0" step="100" />
            <input id="fixed_cost" type="range" min="0" max="200000" step="100" />
          </div>
          <div class="control">
            <div>
              <label for="ad_spend">Ad Spend / mo ($)<span class="info" title="The budget allocated for paid marketing and advertising efforts each month.">ⓘ</span></label>
              <small>Monthly budget for paid advertising and promotions</small>
            </div>
            <input class="number" id="ad_spend_n" type="number" min="0" step="100" />
            <input id="ad_spend" type="range" min="0" max="200000" step="100" />
          </div>
        </div>

        <div class="row">
          <div class="control">
            <div>
              <label for="base_cac">Cost per Lead/Visit (CPL $)<span class="info" title="The average cost to acquire a single lead or website visit through marketing efforts.">ⓘ</span></label>
              <small>Paid traffic cost per visit/lead (not per customer). Customers ≈ visits × conversion.</small>
            </div>
            <input class="number" id="base_cac_n" type="number" min="0.5" step="0.1" />
            <input id="base_cac" type="range" min="0.5" max="100" step="0.1" />
          </div>
          <div class="control">
            <div>
              <label for="conv_rate">Baseline Conversion (%)<span class="info" title="The percentage of leads or website visitors who successfully become paying customers.">ⓘ</span></label>
              <small>Percentage of visitors who become paying customers</small>
            </div>
            <input class="number" id="conv_rate_n" type="number" min="0.01" max="100" step="0.01" />
            <input id="conv_rate" type="range" min="0.01" max="20" step="0.01" />
          </div>
        </div>

        <div class="row">
          <div class="control">
            <div>
              <label for="k_factor">Viral K-Factor<span class="info" title="Average number of new customers each active customer generates per month via referrals (customers, not just prospects).">ⓘ</span></label>
              <small>New customers per active customer per month</small>
            </div>
            <input class="number" id="k_factor_n" type="number" min="0" max="1" step="0.01" />
            <input id="k_factor" type="range" min="0" max="1" step="0.01" />
          </div>
          <div class="control">
            <div>
              <label for="retention">Avg Retention (months)<span class="info" title="The average duration, in months, that a customer continues to use or purchase your product/service.">ⓘ</span></label>
              <small>Average customer lifetime in months (higher value means less churn)</small>
            </div>
            <input class="number" id="retention_n" type="number" min="1" max="60" step="1" />
            <input id="retention" type="range" min="1" max="60" step="1" />
          </div>
        </div>
        
        <div class="row">
          <div class="control">
            <div>
              <label for="units_per">Units per Customer per Month<span class="info" title="The average number of product units an active customer purchases each month.">ⓘ</span></label>
              <small>Average number of units purchased monthly by an active customer</small>
            </div>
            <input class="number" id="units_per_n" type="number" min="0.1" max="10" step="0.1" />
            <input id="units_per" type="range" min="0.1" max="10" step="0.1" />
          </div>
          <div class="control">
            <div>
              <label for="elasticity">Price Elasticity<span class="info" title="A measure of how sensitive customer demand is to price. Typically negative: as price rises, demand falls.">ⓘ</span></label>
              <small>Sensitivity of demand to price changes</small>
            </div>
            <input class="number" id="elasticity_n" type="number" min="-3" max="0" step="0.05" />
            <input id="elasticity" type="range" min="-3" max="0" step="0.05" />
          </div>
        </div>

        <div class="control">
          <div>
            <label for="price_baseline">Elasticity Baseline ($)<span class="info" title="Reference price used to compute the elasticity impact on conversion.">ⓘ</span></label>
            <small>The price point used as a reference for demand sensitivity</small>
          </div>
          <input class="number" id="price_baseline_n" type="number" min="1" step="1" />
          <input id="price_baseline" type="range" min="1" max="999" step="1" />
        </div>
        <div class="control">
          <label style="grid-column: 1 / span 2; display:flex; align-items:center; gap:8px; font-size:12px;">
            <input id="auto_baseline" type="checkbox" /> Baseline tracks current price on run
          </label>
        </div>

        <!-- NEW: Random Seed control -->
        <div class="control">
          <div>
            <label for="seed">Random Seed<span class="info" title="Runs are reproducible: we use seed + run_index for each Monte Carlo path. Same inputs + same seed = same outputs.">ⓘ</span></label>
            <small>Same inputs + same seed ⇒ same results</small>
          </div>
          <input class="number" id="seed_n" type="number" min="0" max="2147483647" step="1" />
          <input id="seed" type="range" min="0" max="2147483647" step="1" />
        </div>
        
        <div class="btnbar">
          <button id="btn-run">Run simulation</button>
          <button id="btn-reset" class="secondary" title="Reset all levers to defaults">Reset defaults</button>
          <button id="btn-set-price-baseline" class="secondary" title="Set current price as elasticity baseline">Set current price as baseline</button>
        </div>
        <div class="footer-note">Tip: tweak a lever and press <b>Run simulation</b>. Monte Carlo adds randomness (CPL, conversion, churn) each run to generate bands.</div>
      </div>
    </aside>

    <!-- RIGHT: Outputs -->
    <section style="display:flex; flex-direction: column; gap: 12px;">
      <div class="card pad">
        <h2>Key Outcomes</h2>
        <div class="kpis">
          <div class="kpi"><div class="label">Expected Revenue (total)</div><div id="kpi_rev" class="value">—</div><div id="kpi_rev_delta" class="delta"></div></div>
          <div class="kpi"><div class="label">Expected Profit (total)</div><div id="kpi_profit" class="value">—</div><div id="kpi_profit_delta" class="delta"></div></div>
          <div class="kpi"><div class="label">Break-even Probability</div><div id="kpi_be_prob" class="value">—</div><div id="kpi_be_time" class="delta"></div></div>
          <div class="kpi"><div class="label">Marketing ROI</div><div id="kpi_roi" class="value">—</div><div class="delta">profit / paid spend</div></div>
        </div>
      </div>

      <div class="card pad">
        <h2>Revenue Over Time (P10 • P50 • P90)</h2>
        <div class="chart"><canvas id="chart_line" width="1280" height="300"></canvas></div>
        <div class="btnbar">
          <button id="btn-export-rev" class="secondary">Export monthly percentiles (CSV)</button>
        </div>
      </div>

      <div class="card pad">
        <h2>Cumulative Net Cashflow Over Time (P10 • P50 • P90)</h2>
        <div class="chart"><canvas id="chart_cash" width="1280" height="300"></canvas></div>
        <div class="btnbar">
          <button id="btn-export-cum-cash" class="secondary">Export cumulative cashflow (CSV)</button>
        </div>
      </div>

      <div class="card pad">
        <h2>Total Profit Distribution</h2>
        <div class="chart"><canvas id="chart_hist" width="1280" height="300"></canvas></div>
        <table class="table" id="tbl_pctls"></table>
        <div class="btnbar">
          <button id="btn-export-profit" class="secondary">Export profit by run (CSV)</button>
        </div>
      </div>

      <div class="card pad">
        <h2>Auto-Insights</h2>
        <div id="insights" class="insights">Run the simulation to generate insights.</div>
      </div>
    </section>
  </main>

  <script>
    // ---------- Utilities ----------
    const fmt = {
      num: (n) => n.toLocaleString(undefined, { maximumFractionDigits: 0 }),
      cur0: (n) => n.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }),
      cur:  (n) => n.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }),
      pct0: (n) => (n*100).toFixed(0) + '%',
      pct1: (n) => (n*100).toFixed(1) + '%',
    };

    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }

    function randNormal(rng) {
      // Box–Muller transform
      let u = 0, v = 0;
      while (u === 0) u = rng();
      while (v === 0) v = rng();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }

    function lognormalNoise(rng, sigma = 0.25) {
      // mean ~ 1.0 by setting mu = -0.5*sigma^2
      const z = randNormal(rng);
      const mu = -0.5 * sigma * sigma;
      return Math.exp(mu + sigma * z);
    }

    function clamp(x, a, b) { return Math.min(Math.max(x, a), b); }

    function percentile(sortedArray, p) {
      if (sortedArray.length === 0) return NaN;
      const idx = (sortedArray.length - 1) * p;
      const lower = Math.floor(idx);
      const upper = Math.ceil(idx);
      if (lower === upper) return sortedArray[lower];
      return sortedArray[lower] + (sortedArray[upper] - sortedArray[lower]) * (idx - lower);
    }

    function mean(arr) { return arr.reduce((a, b) => a + b, 0) / (arr.length || 1); }

    function median(arr) {
      if (!arr.length) return NaN;
      const s = [...arr].sort((a,b)=>a-b);
      const m = Math.floor(s.length/2);
      return s.length % 2 ? s[m] : (s[m-1] + s[m]) / 2;
    }

    function downloadCSV(filename, rows) {
      const csv = rows.map(r => r.map(x => typeof x === 'number' ? String(x) : '"' + String(x).replaceAll('"', '""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.style.display = 'none';
      document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    }

    // ---------- Simple Charts (Canvas) ----------
    function drawLineChart(canvas, labels, seriesList, opts={}) {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr; canvas.height = 300 * dpr; // fixed height
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const W = rect.width, H = 300, pad = 36;
      const xs = (i) => pad + (W - pad*1.5) * (i / (labels.length - 1 || 1));
      const allY = seriesList.flatMap(s => s.data);
      const yMin = Math.min(0, Math.min(...allY));
      const yMax = Math.max(10, Math.max(...allY));
      const ys = (v) => H - pad - (H - pad*2) * ((v - yMin) / (yMax - yMin || 1));

      // gridlines
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--grid');
      ctx.lineWidth = 1; ctx.setLineDash([2,3]);
      const steps = 5;
      for (let g=0; g<=steps; g++) {
        const y = pad + (H - pad*2) * (g/steps);
        ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(W-pad/2, y); ctx.stroke();
      }
      ctx.setLineDash([]);

      // axes
      ctx.strokeStyle = '#444';
      ctx.beginPath(); ctx.moveTo(pad, pad/2); ctx.lineTo(pad, H-pad); ctx.lineTo(W-pad/2, H-pad); ctx.stroke();

      // zero line (y=0) for cashflow readability
      if (opts.zeroLine) {
        const y0 = ys(0);
        if (y0 >= pad/2 && y0 <= H - pad) {
          ctx.save();
          ctx.setLineDash([6,4]);
          ctx.strokeStyle = '#666';
          ctx.beginPath(); ctx.moveTo(pad, y0); ctx.lineTo(W - pad/2, y0); ctx.stroke();
          ctx.fillStyle = '#bdbdbd'; ctx.font = '11px system-ui'; ctx.fillText('$0', 6, y0 - 4);
          ctx.restore();
        }
      }

      // shade between P10 and P90 (assume seriesList[0]=P10, [1]=P50, [2]=P90)
      if (seriesList.length >= 3) {
        const p10 = seriesList[0].data, p90 = seriesList[2].data;
        ctx.beginPath();
        for (let i=0;i<labels.length;i++) ctx.lineTo(xs(i), ys(p10[i]));
        for (let i=labels.length-1;i>=0;i--) ctx.lineTo(xs(i), ys(p90[i]));
        ctx.closePath();
        ctx.fillStyle = 'rgba(230,167,0,0.12)'; // accent with alpha
        ctx.fill();
      }

      // lines
      seriesList.forEach((s, idx) => {
        ctx.beginPath();
        for (let i=0;i<labels.length;i++) {
          const x = xs(i), y = ys(s.data[i]);
          if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.lineWidth = idx===1 ? 2.2 : 1.4; // median thicker
        ctx.strokeStyle = idx===1 ? '#e6a700' : '#9c8b45';
        ctx.stroke();
      });

      // labels (x-axis months)
      ctx.fillStyle = '#9c9c9c'; ctx.font = '11px system-ui';
      const mStep = Math.ceil(labels.length / 12);
      for (let i=0;i<labels.length;i+=mStep) {
        ctx.fillText(labels[i], xs(i)-6, H - pad + 14);
      }

      // y-axis ticks
      for (let g=0; g<=steps; g++) {
        const val = yMax - (yMax - yMin) * (g/steps);
        const text = (val>=1000 ? '$' + Math.round(val/1000)+'k' : '$' + Math.round(val));
        ctx.fillText(text, 6, pad + (H - pad*2) * (g/steps) + 4);
      }

      // legend
      const legend = [ ['P10','10th %ile','#9c8b45'], ['P50','Median','#e6a700'], ['P90','90th %ile','#9c8b45'] ];
      legend.forEach((lg,i)=>{
        const x = W - pad - 140 + i*44, y = pad - 12;
        ctx.fillStyle = lg[2];
        ctx.fillRect(x, y, 18, 4);
        ctx.fillStyle = '#bdbdbd'; ctx.fillText(lg[0], x+22, y+6);
      });
    }

    function drawHistogram2(canvas, data) {
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width * dpr; canvas.height = 300 * dpr;
      const ctx = canvas.getContext('2d');
      ctx.scale(dpr, dpr);
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const W = rect.width, H = 300, pad = 36;
      const nBins = 30;
      const min = Math.min(...data), max = Math.max(...data);
      const bins = new Array(nBins).fill(0);
      const width = (max - min || 1) / nBins;
      data.forEach(v => {
        const idx = Math.min(nBins - 1, Math.floor((v - min) / width));
        bins[idx]++;
      });
      const maxCount = Math.max(...bins);

      // axes
      ctx.strokeStyle = '#444';
      ctx.beginPath(); ctx.moveTo(pad, pad/2); ctx.lineTo(pad, H-pad); ctx.lineTo(W-pad/2, H-pad); ctx.stroke();

      // bars
      const barW = (W - pad*1.5) / nBins;
      for (let i=0;i<nBins;i++) {
        const x = pad + i*barW;
        const y = H - pad;
        const h = (H - pad*2) * (bins[i] / (maxCount || 1));
        ctx.fillStyle = '#e6a700aa';
        ctx.fillRect(x, y - h, barW - 1, h);
      }

      // zero x-line at $0
      if (min <= 0 && max >= 0) {
        const x0 = pad + (W - pad*1.5) * ((0 - min) / (max - min || 1));
        ctx.save();
        ctx.setLineDash([6,4]);
        ctx.strokeStyle = '#666';
        ctx.beginPath(); ctx.moveTo(x0, pad/2); ctx.lineTo(x0, H - pad); ctx.stroke();
        ctx.fillStyle = '#bdbdbd'; ctx.font = '11px system-ui'; ctx.fillText('$0', x0 + 4, pad + 12);
        ctx.restore();
      }

      // x-axis ticks (currency)
      ctx.fillStyle = '#9c9c9c'; ctx.font = '11px system-ui';
      const steps = 5;
      for (let g=0; g<=steps; g++) {
        const v = min + (max - min) * (g/steps);
        const text = v>=1000 ? '$' + Math.round(v/1000)+'k' : '$' + Math.round(v);
        const x = pad + (W - pad*1.5) * (g/steps);
        ctx.fillText(text, x - 10, H - pad + 14);
      }
    }

    // ---------- Model & Simulation ----------
    const defaults = {
      tam: 500000,
      sam_pct: 40,
      months: 24,
      price: 49,
      unit_cost: 25,
      fixed_cost: 25000,
      ad_spend: 15000,
      base_cac: 2.5, // CPL (cost per lead/visit)
      conv_rate: 2.5, // % (visit -> customer)
      k_factor: 0.05,
      retention: 20, // months
      seasonality: 0.10,
      channel_eff: 1.0,
      units_per: 1.2,
      elasticity: -1.0,
      runs: 1000,
      price_baseline: 49,
      auto_baseline: false,   // OFF by default so elasticity shows effect
      seed: 12345             // default seed
    };

    const state = { ...defaults };

    // Function to bind range and number inputs
    function bindInput(id, key) {
        const r = document.getElementById(id); // range input
        const n = document.getElementById(id + '_n'); // number input

        const updateAll = (value) => {
            let clampedValue = value;
            if (r) {
                const min = Number(r.min);
                const max = Number(r.max);
                if (!isNaN(min) && clampedValue < min) clampedValue = min;
                if (!isNaN(max) && clampedValue > max) clampedValue = max;
                r.value = String(clampedValue);
            }
            state[key] = clampedValue;
            if (n) n.value = String(clampedValue);
        };

        if (r) {
            r.addEventListener('input', () => {
                const v = Number(r.value);
                updateAll(v);
                render();
            });
        }

        if (n) {
            n.addEventListener('change', () => {
                const v = Number(n.value);
                if (!isNaN(v)) {
                    updateAll(v);
                    render();
                } else {
                    updateAll(state[key]); // Revert to current state if input is invalid
                }
            });
        }

        // Initialize display and input values
        updateAll(state[key]);
    }

    function resetDefaults() {
      Object.assign(state, { ...defaults });
      [
        'tam','sam_pct','months','price','unit_cost','fixed_cost','ad_spend','base_cac','conv_rate','k_factor','retention','units_per','elasticity','price_baseline','seed'
      ].forEach(id => {
        // Re-bind each control to update their UI elements
        switch (id) {
            case 'tam': bindInput('tam', 'tam'); break;
            case 'price': bindInput('price', 'price'); break;
            case 'unit_cost': bindInput('unit_cost', 'unit_cost'); break;
            case 'fixed_cost': bindInput('fixed_cost', 'fixed_cost'); break;
            case 'ad_spend': bindInput('ad_spend', 'ad_spend'); break;
            case 'base_cac': bindInput('base_cac', 'base_cac'); break;
            case 'conv_rate': bindInput('conv_rate', 'conv_rate'); break;
            case 'sam_pct': bindInput('sam_pct', 'sam_pct'); break;
            case 'months': bindInput('months', 'months'); break;
            case 'k_factor': bindInput('k_factor', 'k_factor'); break;
            case 'retention': bindInput('retention', 'retention'); break;
            case 'units_per': bindInput('units_per', 'units_per'); break;
            case 'elasticity': bindInput('elasticity', 'elasticity'); break;
            case 'price_baseline': bindInput('price_baseline', 'price_baseline'); break;
            case 'seed': bindInput('seed', 'seed'); break;
        }
      });
      const ab = document.getElementById('auto_baseline');
      if (ab) ab.checked = state.auto_baseline;
      render();
    }

    function currentParams() {
      return {
        tam: Number(state.tam),
        sam: Math.round(Number(state.tam) * (Number(state.sam_pct)/100)),
        months: Number(state.months),
        price: Number(state.price),
        unit_cost: Number(state.unit_cost),
        fixed_cost: Number(state.fixed_cost),
        ad_spend: Number(state.ad_spend),
        base_cac: Math.max(0.1, Number(state.base_cac)),
        conv_rate: Math.max(0.0001, Number(state.conv_rate)/100), // Convert percentage to decimal for simulation
        k_factor: Math.max(0, Number(state.k_factor)),
        retention: Math.max(1, Number(state.retention)),
        seasonality: defaults.seasonality, // Use default
        channel_eff: defaults.channel_eff, // Use default
        units_per: Math.max(0.01, Number(state.units_per)),
        elasticity: Number(state.elasticity),
        runs: Math.round(Number(state.runs)),
        price_baseline: Number(state.price_baseline),
        seed: Math.floor(Number(state.seed)) >>> 0
      };
    }

    function simulate(params) {
      const { months } = params;
      const revRuns = Array.from({length: months}, () => new Array(params.runs).fill(0));
      const monthlyCashRuns = Array.from({length: months}, () => new Array(params.runs).fill(0)); 
      const cumCashRuns = Array.from({length: months}, () => new Array(params.runs).fill(0)); 
      const profitTotals = new Array(params.runs).fill(0);
      const beMonths = new Array(params.runs).fill(Infinity);

      for (let run = 0; run < params.runs; run++) {
        // Seeded RNG per run for reproducibility
        const rng = mulberry32((params.seed + run) >>> 0);

        let active = 0;
        let acquiredTotal = 0;
        const addressable = Math.max(0, params.sam);
        let cumProfitThisRun = 0;

        for (let m = 0; m < months; m++) {
          // seasonality ~ sine wave around 1.0 (using default.seasonality)
          const season = 1 + params.seasonality * Math.sin(2 * Math.PI * ((m % 12) / 12));

          // random CAC and conversion noise (log-normal multiplicative)
          const convNoise = lognormalNoise(rng, 0.25);
          const cacNoise = lognormalNoise(rng, 0.20);
          const churnNoise = lognormalNoise(rng, 0.15);
          // price elasticity (demand factor)
          const priceFactor = Math.pow(params.price / params.price_baseline, params.elasticity);

          // effective conversion rate and CAC
          const convRaw = Math.max(0, params.conv_rate * season * convNoise * priceFactor);
          const conv = clamp(convRaw, 0, 1); // cap to [0,1]
          const cac = Math.max(0.1, (params.base_cac / params.channel_eff) * cacNoise); // align to UI min

          // paid + organic
          const paidProspects = params.ad_spend / cac; 
          const remaining = Math.max(0, addressable - acquiredTotal);

          // viral K as customers per active
          const organicCustomers = params.k_factor * active;

          // paid customers
          const paidCustomers = Math.min(paidProspects, remaining) * conv;

          const newCustomers = Math.min(organicCustomers + paidCustomers, remaining);
          acquiredTotal += newCustomers;

          // churn (geometric with mean=retention months)
          const monthlyChurnRate = clamp(1 / params.retention, 0.001, 0.95);
          const lost = Math.min(active, active * monthlyChurnRate * churnNoise);

          active = Math.max(0, active + newCustomers - lost);

          const units = active * params.units_per;
          const revenue = units * params.price;
          const variableCost = units * params.unit_cost;
          const gross = revenue - variableCost;
          const opex = params.fixed_cost + params.ad_spend;
          const opProfit = gross - opex;

          revRuns[m][run] = revenue;
          monthlyCashRuns[m][run] = opProfit; 
          
          cumProfitThisRun += opProfit; 
          cumCashRuns[m][run] = cumProfitThisRun; 

          if (beMonths[run] === Infinity && cumProfitThisRun >= 0) beMonths[run] = m + 1;
          if (m === months - 1) profitTotals[run] = cumProfitThisRun;
        }
      }

      // Aggregate percentiles per month
      const p10 = [], p50 = [], p90 = [], labels = []; 
      const cumCashP10 = [], cumCashP50 = [], cumCashP90 = []; 

      for (let m=0;m<months;m++) {
        const arr = revRuns[m].slice().sort((a,b)=>a-b);
        p10.push(percentile(arr, 0.10));
        p50.push(percentile(arr, 0.50));
        p90.push(percentile(arr, 0.90));

        const cumulativeArr = cumCashRuns[m].slice().sort((a,b)=>a-b);
        cumCashP10.push(percentile(cumulativeArr, 0.10));
        cumCashP50.push(percentile(cumulativeArr, 0.50));
        cumCashP90.push(percentile(cumulativeArr, 0.90));

        labels.push('M' + (m+1));
      }

      const profitSorted = profitTotals.slice().sort((a,b)=>a-b);
      const profitP10 = percentile(profitSorted, 0.10);
      const profitP50 = percentile(profitSorted, 0.50);
      const profitP90 = percentile(profitSorted, 0.90);

      const beFinite = beMonths.filter(x => isFinite(x));
      const beProb = beFinite.length / params.runs;
      const beMed = beFinite.length ? median(beFinite) : Infinity;
      const beP90 = beFinite.length ? percentile(beFinite.slice().sort((a,b)=>a-b), 0.90) : Infinity;

      const expectedRevenue = p50.reduce((a,b)=>a+b,0);
      const expectedProfit = mean(profitTotals);
      const mktSpend = params.ad_spend * params.months;
      const roi = expectedProfit / Math.max(1, mktSpend);

      return { labels, p10, p50, p90, cumCashP10, cumCashP50, cumCashP90, profitTotals, profitP10, profitP50, profitP90, beProb, beMed, beP90, expectedRevenue, expectedProfit, roi };
    }

    // ---------- Rendering ----------
    const lineCanvas = document.getElementById('chart_line');
    const cashCanvas = document.getElementById('chart_cash');
    const histCanvas = document.getElementById('chart_hist');

    let lastResult = null;

    function render() {
      const autoBaselineCheckbox = document.getElementById('auto_baseline');
      if (autoBaselineCheckbox && autoBaselineCheckbox.checked) { 
        state.price_baseline = Number(state.price); 
        // Also update the UI for price_baseline if it's set automatically
        const priceBaselineN = document.getElementById('price_baseline_n');
        const priceBaselineRange = document.getElementById('price_baseline');
        if (priceBaselineN) priceBaselineN.value = String(state.price_baseline);
        if (priceBaselineRange) priceBaselineRange.value = String(state.price_baseline);
      }
      
      const p = currentParams();
      lastResult = simulate(p);

      // KPIs
      document.getElementById('kpi_rev').textContent = fmt.cur0(lastResult.expectedRevenue);
      document.getElementById('kpi_profit').textContent = fmt.cur0(lastResult.expectedProfit);
      document.getElementById('kpi_be_prob').textContent = fmt.pct0(lastResult.beProb);
      document.getElementById('kpi_roi').textContent = (lastResult.roi>=0 ? '+' : '') + (lastResult.roi*100).toFixed(0) + '%';

      const beTxt = isFinite(lastResult.beMed)
        ? `Median time to break-even: ~M${Math.round(lastResult.beMed)} (P90: M${Math.round(lastResult.beP90)})`
        : 'Break-even unlikely within horizon';
      document.getElementById('kpi_be_time').textContent = beTxt;

      // Charts
      drawLineChart(lineCanvas, lastResult.labels, [
        { name: 'P10', data: lastResult.p10 },
        { name: 'P50', data: lastResult.p50 },
        { name: 'P90', data: lastResult.p90 },
      ], {zeroLine:false});
      
      if (cashCanvas) {
        drawLineChart(cashCanvas, lastResult.labels, [
          { name: 'CumP10', data: lastResult.cumCashP10 }, 
          { name: 'CumP50', data: lastResult.cumCashP50 }, 
          { name: 'CumP90', data: lastResult.cumCashP90 }, 
        ], {zeroLine:true});
      }
      drawHistogram2(histCanvas, lastResult.profitTotals);

      // Table of percentiles for profit
      const tbl = document.getElementById('tbl_pctls');
      tbl.innerHTML = `
        <tr><th>Metric</th><th>Value</th></tr>
        <tr><td>Profit P10</td><td>${fmt.cur0(lastResult.profitP10)}</td></tr>
        <tr><td>Profit P50 (median)</td><td>${fmt.cur0(lastResult.profitP50)}</td></tr>
        <tr><td>Profit P90</td><td>${fmt.cur0(lastResult.profitP90)}</td></tr>
      `;

      // Insights
      const insights = [];
      if (lastResult.beProb === 0) {
        insights.push('Break-even is <b>0%</b> under current settings because cumulative profit never turns positive. Check volume drivers: <b>CPL</b> and <b>Conversion</b> (since <i>customers ≈ visits × conversion</i>) and compare gross margin vs. fixed+ad spend.');
      }
      if (lastResult.beProb < 0.5) {
        insights.push(`With the current levers, break-even within ${p.months} months is <b>${fmt.pct0(lastResult.beProb)}</b>. Consider raising <b>price</b>, improving <b>channel efficiency</b>, or trimming <b>fixed/ad spend</b>.`);
      } else {
        insights.push(`You have a >50% chance to break even by <b>M${Math.round(lastResult.beMed)}</b> (P90 by M${Math.round(lastResult.beP90)}).`);
      }
      if (p.elasticity < -1.2) {
        insights.push(`High (elastic) demand: price increases hurt conversion notably (elasticity ${p.elasticity}). Test smaller price steps.`);
      } else if (p.elasticity > -0.6) {
        insights.push(`Low (inelastic) demand: conversion is less sensitive to price changes (elasticity ${p.elasticity}). Pricing power may exist.`);
      }
      if (p.seasonality > 0.25) insights.push(`Strong seasonality (±${Math.round(p.seasonality*100)}%) suggests budgeting more paid media ahead of peak months.`);
      if (p.k_factor >= 0.05) insights.push(`Viral growth (K=${p.k_factor.toFixed(2)}) meaningfully amplifies acquisition as active base grows. Invest in referrals.`);

      document.getElementById('insights').innerHTML = insights.map(x => `<div>• ${x}</div>`).join('');
    }

    // ---------- Wiring ----------
    bindInput('tam', 'tam');
    bindInput('sam_pct', 'sam_pct');
    bindInput('months', 'months');
    bindInput('price', 'price');
    bindInput('unit_cost', 'unit_cost');
    bindInput('fixed_cost', 'fixed_cost');
    bindInput('ad_spend', 'ad_spend');
    bindInput('base_cac', 'base_cac');
    bindInput('conv_rate', 'conv_rate');
    bindInput('k_factor', 'k_factor');
    bindInput('retention', 'retention');
    bindInput('units_per', 'units_per');
    bindInput('elasticity', 'elasticity');
    bindInput('price_baseline', 'price_baseline');
    bindInput('seed', 'seed');

    document.getElementById('btn-run').addEventListener('click', render);
    
    document.getElementById('btn-reset').addEventListener('click', resetDefaults);
    document.getElementById('btn-set-price-baseline').addEventListener('click', () => {
      state.price_baseline = Number(state.price);
      const ab = document.getElementById('auto_baseline'); if (ab) { ab.checked = false; state.auto_baseline = false; }
      
      const priceBaselineN = document.getElementById('price_baseline_n');
      const priceBaselineRange = document.getElementById('price_baseline');

      if (priceBaselineN) priceBaselineN.value = String(state.price_baseline);
      if (priceBaselineRange) priceBaselineRange.value = String(state.price_baseline);

      const msg = document.createElement('div');
      msg.textContent = `Elasticity baseline set to ${fmt.cur(state.price_baseline)}`;
      msg.style.cssText = 'position:fixed; bottom:16px; right:16px; background:#111; border:1px solid #333; color:#e0e0e0; padding:8px 12px; border-radius:10px; z-index:9;';
      document.body.appendChild(msg);
      setTimeout(()=>msg.remove(), 2400);
      render();
    });

    // Exports
    document.getElementById('btn-export-rev').addEventListener('click', () => {
      if (!lastResult) return;
      const rows = [['Month','Revenue_P10','Revenue_P50','Revenue_P90']];
      for (let i=0;i<lastResult.labels.length;i++) rows.push([lastResult.labels[i], Math.round(lastResult.p10[i]), Math.round(lastResult.p50[i]), Math.round(lastResult.p90[i])]);
      downloadCSV('monthly_revenue_percentiles.csv', rows);
    });

    // New export for cumulative cashflow
    document.getElementById('btn-export-cum-cash').addEventListener('click', () => {
      if (!lastResult) return;
      const rows = [['Month','Cumulative_Cashflow_P10','Cumulative_Cashflow_P50','Cumulative_Cashflow_P90']];
      for (let i=0;i<lastResult.labels.length;i++) rows.push([lastResult.labels[i], Math.round(lastResult.cumCashP10[i]), Math.round(lastResult.cumCashP50[i]), Math.round(lastResult.cumCashP90[i])]);
      downloadCSV('cumulative_cashflow_percentiles.csv', rows);
    });

    document.getElementById('btn-export-profit').addEventListener('click', () => {
      if (!lastResult) return;
      const rows = [['Run','Total_Profit']];
      lastResult.profitTotals.forEach((v,i)=>rows.push([i+1, Math.round(v)]));
      downloadCSV('profit_distribution.csv', rows);
    });

    // Re-render on resize to keep canvases crisp
    window.addEventListener('resize', () => { 
      if (!lastResult) return;
      drawLineChart(lineCanvas, lastResult.labels, [{data:lastResult.p10},{data:lastResult.p50},{data:lastResult.p90}], {zeroLine:false}); 
      if (cashCanvas) { 
        drawLineChart(cashCanvas, lastResult.labels, [{data:lastResult.cumCashP10},{data:lastResult.cumCashP50},{data:lastResult.cumCashP90}], {zeroLine:true}); 
      } 
      drawHistogram2(histCanvas, lastResult.profitTotals); 
    });

    // Tooltips init (upgrade 'title' to custom tooltip)
    (function initTooltips(){
      const infos = document.querySelectorAll('.info');
      infos.forEach(el => {
        if (!el.dataset.tip && el.getAttribute('title')) { el.dataset.tip = el.getAttribute('title'); el.removeAttribute('title'); }
        el.setAttribute('tabindex','0');
        el.addEventListener('click', (e)=>{ e.stopPropagation(); el.classList.toggle('show'); setTimeout(()=>el.classList.remove('show'), 2500); });
      });
      document.addEventListener('click', ()=>{ document.querySelectorAll('.info.show').forEach(x=>x.classList.remove('show')); });
    })();

    // Initialize UI with defaults and first render
    resetDefaults();
  </script>
</body>
</html>
